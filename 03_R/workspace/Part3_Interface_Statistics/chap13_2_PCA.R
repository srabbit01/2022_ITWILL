###########################
### 주성분분석 실습
###########################
# 실습 목적 : 6개 과목의 특징을 대상으로 주성분분석 수행 -> 유사 과목 파악    
# 변수 설명 : 6개 과목에 대한 10개의 특징 수치화(5점 척도) 
# s1 : 자연과학, s2 : 물리화학
# s3 : 인문사회, s4 : 신문방송
# s5 : 응용수학, s6 : 추론통계
s1 <- c(1, 2, 1, 2, 3, 4, 2, 3, 4, 5)
s2 <- c(1, 3, 1, 2, 3, 4, 2, 4, 3, 4)
s3 <- c(2, 3, 2, 3, 2, 3, 5, 3, 4, 2)
s4 <- c(2, 4, 2, 3, 2, 3, 5, 3, 4, 1)
s5 <- c(4, 5, 4, 5, 2, 1, 5, 2, 4, 3)
s6 <- c(4, 3, 4, 4, 2, 1, 5, 2, 4, 2)
name <-1:10 


# dataset 가져오기 
dataset <- data.frame(s1, s2, s3, s4, s5, s6)
dataset
str(dataset) # 'data.frame':	10 obs. of  6 variables:

# [단계1] 데이터 특성 파악 
cor(dataset)
#             s1          s2         s3         s4         s5         s6
# s1  1.00000000  0.86692145 0.05847768 -0.1595953 -0.5504588 -0.6262758
# s2  0.86692145  1.00000000 0.06745441 -0.0240123 -0.6349581 -0.7968892
# s3  0.05847768  0.06745441 1.00000000  0.9239433  0.3506967  0.4428759
# s4 -0.15959528 -0.02401230 0.92394333  1.0000000  0.4207582  0.4399890
# s5 -0.55045878 -0.63495808 0.35069667  0.4207582  1.0000000  0.8733514
# s6 -0.62627585 -0.79688923 0.44287589  0.4399890  0.8733514  1.0000000

# s1과 s2, s3와 s4, s5와 s6 상관성 있음

# [단계2] 가중계수 추출 : 고유값과 고유벡터 : chap13_1_Eigenvalue 참고 
# 고유값(λ)  # 정방행렬 대상 -> cor 상관계수 행렬 이용
en <- eigen(cor(dataset)) # 상관계수행렬 이용 고유값과 고유벡터 생성    
class(en)
names(en) # "values"  "vectors" = 고유값 고유벡터

en$values # 고유값 보기  
# 3.44393944 1.88761725 0.43123968 0.19932073 0.02624961 0.01163331
# - 고유값이란 어떤 행렬(상관관계수 행렬)로부터 유도되는 특정한 상수값

# 기요율 = 고유값/총분산(고유값총합)
prop.table(en$values/sum(en$values))
# [1] 0.573989906 0.314602874 0.071873280 0.033220121 0.004374934 0.001938885
0.573989906+0.314602874 # 0.8885928: PC1+PC2 기여율
0.573989906+0.314602874+0.071873280 # 0.9604661: PC1+PC2+PC3 기여율

en$vectors # 고유벡터 
#           [,1]         [,2]        [,3]       [,4]        [,5]        [,6]
#[1,] -0.4062499 -0.351093036  0.63460534  0.3149622  0.45699508  0.03041553
#[2,] -0.4319311 -0.400526644  0.11564711 -0.4422216 -0.57042232  0.34452594
#[3,]  0.2542077 -0.628807884 -0.06984072  0.3339036 -0.35389906 -0.54622817
#[4,]  0.3017115 -0.566028650 -0.37734321 -0.2468016  0.50326085  0.36333366
#[5,]  0.4763815  0.008436692  0.58035475 -0.6016209  0.05643527 -0.26654314
#[6,]  0.5155637  0.021286661  0.31595023  0.4133867 -0.28995329  0.61559319

plot(en$values, type="o") # 고유값을 이용한 시각화(elbow point 기준) 
# 꺾은 지점(elbow point)를 주성분의 개수로 지정


# [단계3] 차원축소 : 주성분분석
?prcomp
# 상관계수를 적용한 고유벡터와 관측치 간의 선형결합 : dataset의 상관계수행렬을 이용하여 주성분분석 수행   
PCA <- prcomp(dataset, center = TRUE, scale. = TRUE) # 변수들의 단위가 다른경우 적용  
# center = TRUE, scale. = TRUE -> 평균=0, 분산=1

# prcomp() 함수: 차원축소 함수 -> 기본 패키지 제공
# scale: TRUE면 표준화 실행

PCA # 주성분의 분산과 회전값
# Standard deviations (1, .., p=6): -> 주성분의 분산(표준편차) = sqrt(en$values) = 고유값의 제곱근
# 새로 변형된 표준편차 = 고유값의 루트
#  [1] 1.8557854 1.3739058 0.6566884 0.4464535 0.1620173 0.1078578

# Rotation (n x k) = (6 x 6): -> 주성분의 회전값 = 고유벡터의 부호를 회전시킨 값 = -(en$vectors)
#           PC1          PC2         PC3        PC4         PC5         PC6
# s1  0.4062499  0.351093036 -0.63460534  0.3149622  0.45699508  0.03041553
# s2  0.4319311  0.400526644 -0.11564711 -0.4422216 -0.57042232  0.34452594
# s3 -0.2542077  0.628807884  0.06984072  0.3339036 -0.35389906 -0.54622817
# s4 -0.3017115  0.566028650  0.37734321 -0.2468016  0.50326085  0.36333366
# s5 -0.4763815 -0.008436692 -0.58035475 -0.6016209  0.05643527 -0.26654314
# s6 -0.5155637 -0.021286661 -0.31595023  0.4133867 -0.28995329  0.61559319



# 주성분분석의 속성  
names(PCA) # "sdev"     "rotation" "center"   "scale"    "x"   
# sdev, rotation: 회전값, x 속성이 중요함 
PCA$center
PCA$scale

# 1) 각 주성분의 분산
PCA$sdev # 1.8557854 1.3739058 0.6566884 0.4464535 0.1620173 0.1078578
sqrt(en$values)

# 2) 각 주성분의 회전값 
PCA$rotation
-(en$vectors)


# 3) x : 주성분 점수 = 주성분 분석의 최종 결과물
PCA$x # 차원축소에 이용
# 6개 -> 3개로 차원축소
round(PCA$x[,1:3],2) # 기여도가 높은 주성분 변수 3개만 추출
#            PC1        PC2        PC3
#[1,] -1.2195113 -2.0459190  0.2058941
#[2,] -0.8619728  0.4960040  0.0733061
#[3,] -1.2195113 -2.0459190  0.2058941
#[4,] -1.3831687 -0.3387559 -0.3876923
#[5,]  1.5989191 -0.7852011  0.3581558
#[6,]  2.5004922  0.9502748  0.8197018
#[7,] -2.7991446  1.8549340  0.1375841
#[8,]  1.4637914  0.6653457  0.6438323
#[9,] -0.5785476  1.6426768 -0.6461737
#[10,]  2.4986537 -0.3934403 -1.4105023

# 주성분 점수 = 표준화된 관측치 %*% PCA$roration(고유벡터) -> 선형결합
# %*% (선형결합 행렬곱)
dataset_scale=scale(dataset)
rot=PCA$rotation[,1:3]
dataset_scale %*% rot

# [단계4] 주성분 개수 결정 
summary(PCA) #주성분 분석에 대한 결과 요약 설명
#Importance of components:
#                         PC1    PC2     PC3     PC4     PC5     PC6
#Standard deviation     1.856 1.3739 0.65669 0.44645 0.16202 0.10786
#Proportion of Variance 0.574 0.3146 0.07187 0.03322 0.00437 0.00194
#Cumulative Proportion  0.574 0.8886 0.96047 0.99369 0.99806 1.00000

#Standard deviation : 표준편차 
#Propertion of Variance : 분산비율, 각 주성분이 차지하는 비율
#Cumulative Proportion : PC1부터 분산의 누적 합계(85%이상인 주성분까지 선택) 


# 스크리 플롯 : 주성분 개수를 선택할 수 있는 그래프(Elbow Point : 완만해지기 이전 선택)
plot(PCA, type="l",sub = "Scree Plot") # 3


biplot(PCA) # 행렬도(biplot) 
# - 원변수와 PCA간의 관계를 그래프로 표현(차원 축소 정보 제공)
# - 화살표는 원변수와 PC의 상관계수. PC와 평행할수록 해당 PC에 큰 영향


# 3차원 시각화 : 주성분 3개 시각화 
install.packages('scatterplot3d')
library(scatterplot3d)

# 주성분 3개 점수 추출 
PC1 <- PCA$x[,1]
PC2 <- PCA$x[,2]
PC3 <- PCA$x[,3] 

# scatterplot3d(밑변, 오른쪽변, 왼쪽변, type='p') # type='p' : 기본산점도 표시 
d3 <- scatterplot3d(PC1, PC2, PC3)

# 각 주성분의 rotation값(고유벡터) 
rotation1 <- PCA$rotation[,1]
rotation1
rotation2 <- PCA$rotation[,2]
rotation2
rotation3 <- PCA$rotation[,3] 
PCA$rotation
d3$points3d(rotation1, rotation2, rotation3, bg='red',pch=21, cex=2, type='h')


# [5단계] 입력변수 생성: 주성분 점수 이용
dataset # 10행 6열

dataset=PCA$x[,1:3]
class(dataset)

new_dataset=data.frame(dataset)

names(new_dataset)=c('app_science','soc_science','net_science') # 5,6 3,4 1,2
new_dataset # 10행 3열 (차원축소)

